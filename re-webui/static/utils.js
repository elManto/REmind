var fourth_binary_edges = {'pple44514841': {'0x4006f8': {'t': '0x400704', 'f': '0x400704'}, '0x4006e5': {'t': '0x4006f6', 'f': '0x4006f6'}, '0x4006ca': {'t': '0x4006f8', 'f': '0x4006e5'}, '0x400704': {}, '0x4006f6': {}, '0x40070e': {}}, 'f0144567': {'0x400711': {'t': '0x40073f', 'f': '0x40072c'}, '0x40072c': {'t': '0x40073d', 'f': '0x40073d'}, '0x40074b': {}, '0x40073f': {'t': '0x40074b', 'f': '0x40074b'}, '0x40073d': {}, '0x400755': {}}, 'y5nasss': {'0x4007a0': {}, '0x400794': {'t': '0x4007a0', 'f': '0x4007a0'}, '0x40078a': {}, '0x400758': {'t': '0x400794', 'f': '0x40077e'}, '0x40077e': {'t': '0x40078a', 'f': '0x40078a'}}, 'x73nuf8efhaa': {'0x4007aa': {'t': '0x4007d3', 'f': '0x4007c5'}, '0x4007e9': {}, '0x4007d3': {'t': '0x4007df', 'f': '0x4007df'}, '0x4007d1': {}, '0x4007c5': {'t': '0x4007d1', 'f': '0x4007d1'}, '0x4007df': {}}, 'z93mm999asmt': {'0x400821': {}, '0x400815': {'t': '0x400821', 'f': '0x400821'}, '0x400807': {'t': '0x400813', 'f': '0x400813'}, '0x400813': {}, '0x40082b': {}, '0x4007ec': {'t': '0x400815', 'f': '0x400807'}}, 'main': {'0x4008a3': {}, '0x40085c': {'t': '0x400868', 'f': '0x400868'}, '0x400897': {'t': '0x4008a3', 'f': '0x4008a3'}, '0x400872': {'t': '0x400897', 'f': '0x400884'}, '0x400868': {}, '0x400884': {'t': '0x400897', 'f': '0x400897'}, '0x400843': {'t': '0x400856', 'f': '0x400856'}, '0x400856': {'t': '0x400872', 'f': '0x40085c'}, '0x40082e': {'t': '0x40085c', 'f': '0x400843'}}}


var first_binary_edges = {'MAIN': {'0x400c1f': {'t': '0x400c8e', 'f': '0x400c8e'}, '0x400b7a': {'t': '0x400bb3', 'f': '0x400bb3'}, '0x400c25': {'t': '0x400c34', 'f': '0x400c34'}, '0x400c67': {'t': '0x400c3d', 'f': '0x400c70'}, '0x400bd1': {'t': '0x400be3', 'f': '0x400be3'}, '0x400c3d': {'t': '0x400c52', 'f': '0x400c52'}, '0x400bf0': {'t': '0x400c0a', 'f': '0x400c0a'}, '0x400c8e': {'t': '0x400ca2', 'f': '0x400c9d'}, '0x400bb3': {'t': '0x400bc0', 'f': '0x400bc0'}, '0x400be3': {'t': '0x400bf0', 'f': '0x400bf0'}, '0x400c0a': {'t': '0x400c17', 'f': '0x400c17'}, '0x400c34': {'t': '0x400c52', 'f': '0x400c52'}, '0x400c17': {'t': '0x400c25', 'f': '0x400c1e'}, '0x400c76': {'t': '0x400c82', 'f': '0x400c82'}, '0x400c52': {'t': '0x400c67', 'f': '0x400c67'}, '0x400c70': {'t': '0x400c89', 'f': '0x400c76'}, '0x400ca2': {}, '0x400c9d': {}, '0x400bc0': {'t': '0x400bd1', 'f': '0x400bc7'}, '0x400bc7': {'t': '0x400c8e', 'f': '0x400c8e'}, '0x400c89': {'t': '0x400ca2', 'f': '0x400c9d'}, '0x400c82': {'t': '0x400c8e', 'f': '0x400c8e'}}, 'sub_400cb4': {'0x400cb4': {'t': '0x400cdd', 'f': '0x400cc5'}, '0x400ce2': {}, '0x400cdd': {}, '0x400cd6': {'t': '0x400ce2', 'f': '0x400ce2'}, '0x400cc5': {'t': '0x400cd6', 'f': '0x400cd6'}}, 'sub_400e60': {'0x400ee8': {}, '0x400e5c': {'t': '0x400e79', 'f': '0x400e79'}, '0x400e79': {'t': '0x400e8b', 'f': '0x400e8b'}, '0x400ed0': {'t': '0x400edc', 'f': '0x400edc'}, '0x400ece': {}, '0x400e94': {'t': '0x400ea0', 'f': '0x400ea0'}, '0x400edc': {'t': '0x400ee8', 'f': '0x400ee8'}, '0x400ea8': {'t': '0x400ec1', 'f': '0x400ec1'}, '0x400ec1': {'t': '0x400ece', 'f': '0x400ece'}, '0x400e8b': {'t': '0x400ea2', 'f': '0x400e94'}, '0x400ea2': {'t': '0x400ed0', 'f': '0x400ea8'}, '0x400ea0': {}}, 'sub_400ce4': {'0x400d31': {'t': '0x400d4b', 'f': '0x400d4b'}, '0x400dde': {'t': '0x400ded', 'f': '0x400ded'}, '0x400ded': {'t': '0x400e02', 'f': '0x400dfd'}, '0x400dd2': {'t': '0x400dde', 'f': '0x400dde'}, '0x400db8': {'t': '0x400dc7', 'f': '0x400dc7'}, '0x400dac': {'t': '0x400db8', 'f': '0x400db8'}, '0x400ce4': {'t': '0x400d31', 'f': '0x400d31'}, '0x400d4d': {'t': '0x400d5c', 'f': '0x400d5c'}, '0x400dc9': {'t': '0x400dde', 'f': '0x400dd2'}, '0x400dc7': {}, '0x400e02': {}, '0x400d5c': {'t': '0x400d76', 'f': '0x400d76'}, '0x400d4b': {}, '0x400d94': {'t': '0x400d4d', 'f': '0x400da3'}, '0x400da3': {'t': '0x400dc9', 'f': '0x400dac'}, '0x400d76': {'t': '0x400d94', 'f': '0x400d94'}, '0x400dfd': {}}, 'sub_400e08': {'0x400e4d': {'t': '0x400e59', 'f': '0x400e59'}, '0x400e59': {}, '0x400e04': {'t': '0x400e59', 'f': '0x400e4d'}}, 'sub_400ca4': {'0x400ca4': {}}};

var second_binary_edges = {'sub_4006d8': {'0x4006ea': {}, '0x4006e8': {}, '0x4006d8': {'t': '0x4006ea', 'f': '0x4006e8'}}, 'sub_400790': {'0x400790': {'t': '0x4007ba', 'f': '0x4007ba'}, '0x4007ba': {}}, 'sub_400861': {'0x400867': {}, '0x400873': {}, '0x400878': {}, '0x400861': {'t': '0x400873', 'f': '0x400867'}}, 'sub_40089a': {'0x4008e9': {'t': '0x4008c4', 'f': '0x4008f0'}, '0x4008f0': {'t': '0x4008fc', 'f': '0x4008fc'}, '0x40089a': {'t': '0x4008c2', 'f': '0x4008c2'}, '0x4008c4': {'t': '0x4008dd', 'f': '0x4008dd'}, '0x4008dd': {'t': '0x4008c4', 'f': '0x4008f0'}, '0x4008fc': {}, '0x4008c2': {}}, 'sub_400937': {'0x4009c6': {'t': '0x40098f', 'f': '0x4009ce'}, '0x40098f': {'t': '0x4009ad', 'f': '0x40099a'}, '0x40094f': {'t': '0x40096b', 'f': '0x400958'}, '0x40096b': {'t': '0x4009c6', 'f': '0x4009c6'}, '0x4009ad': {'t': '0x40098f', 'f': '0x4009ce'}, '0x4009da': {}, '0x4009ce': {'t': '0x4009da', 'f': '0x4009da'}, '0x400937': {'t': '0x40094f', 'f': '0x40094f'}, '0x400958': {'t': '0x400964', 'f': '0x400964'}, '0x4009df': {}, '0x40099a': {'t': '0x4009a6', 'f': '0x4009a6'}, '0x4009a6': {'t': '0x4009df', 'f': '0x4009df'}, '0x400964': {'t': '0x4009df', 'f': '0x4009df'}}, 'sub_400a5f': {'0x400a5f': {}}, 'sub_400acc': {'0x400b05': {'t': '0x400af0', 'f': '0x400b0c'}, '0x400af0': {'t': '0x400af0', 'f': '0x400b0c'}, '0x400b0c': {}, '0x400acc': {'t': '0x400b05', 'f': '0x400b05'}}, 'sub_400b80': {'0x400bf4': {'t': '0x400b9a', 'f': '0x400bfc'}, '0x400bb9': {'t': '0x400bf0', 'f': '0x400bbd'}, '0x400bf0': {'t': '0x400b9a', 'f': '0x400bfc'}, '0x400b80': {'t': '0x400bf4', 'f': '0x400bf4'}, '0x400b9a': {'t': '0x400bb9', 'f': '0x400bb9'}, '0x400bdc': {'t': '0x400bf0', 'f': '0x400bf0'}, '0x400bfc': {}, '0x400bbd': {'t': '0x400bdc', 'f': '0x400bdc'}}, 'sub_400c4b': {'0x400c4b': {'t': '0x400c70', 'f': '0x400c70'}, '0x400c7c': {'t': '0x400c95', 'f': '0x400c95'}, '0x400caa': {}, '0x400c9e': {'t': '0x400caa', 'f': '0x400caa'}, '0x400c95': {'t': '0x400caa', 'f': '0x400c9e'}, '0x400c70': {'t': '0x400c7c', 'f': '0x400c7c'}}, 'sub_400d18': {'0x400d55': {}, '0x400d18': {'t': '0x400d3d', 'f': '0x400d3d'}, '0x400d3d': {'t': '0x400d49', 'f': '0x400d49'}, '0x400d49': {'t': '0x400d55', 'f': '0x400d55'}}, 'sub_400e34': {'0x400e66': {}, '0x400e34': {'t': '0x400e41', 'f': '0x400e41'}, '0x400e5d': {'t': '0x400e50', 'f': '0x400e66'}, '0x400e50': {'t': '0x400e5d', 'f': '0x400e5d'}, '0x400e46': {'t': '0x400e5d', 'f': '0x400e5d'}, '0x400e41': {'t': '0x400e66', 'f': '0x400e46'}}, 'sub_4006f0': {'0x4006f0': {}}, 'sub_4007c0': {'0x4007d7': {'t': '0x4007f0', 'f': '0x4007e3'}, '0x4007f0': {}, '0x4007c0': {'t': '0x4007f0', 'f': '0x4007d7'}, '0x4007e3': {}}, 'sub_400890': {'0x400840': {}, '0x400834': {}, '0x400828': {'t': '0x400840', 'f': '0x400834'}, '0x400800': {'t': '0x400840', 'f': '0x400828'}, '0x400890': {'t': '0x400800', 'f': '0x400800'}}, 'sub_4008ff': {'0x4008ff': {'t': '0x40092b', 'f': '0x40092b'}, '0x40091b': {'t': '0x40091b', 'f': '0x400932'}, '0x40092b': {'t': '0x40091b', 'f': '0x400932'}, '0x400932': {}}, 'sub_4009e1': {'0x400a5d': {}, '0x400a43': {'t': '0x400a37', 'f': '0x400a50'}, '0x400a37': {'t': '0x400a37', 'f': '0x400a50'}, '0x4009e1': {'t': '0x4009fa', 'f': '0x4009fa'}, '0x400a50': {}, '0x4009fa': {'t': '0x400a43', 'f': '0x400a2a'}, '0x400a2a': {'t': '0x400a5d', 'f': '0x400a5d'}}, 'sub_400a72': {'0x400ab7': {'t': '0x400a8f', 'f': '0x400abe'}, '0x400a72': {'t': '0x400ab7', 'f': '0x400ab7'}, '0x400a8f': {'t': '0x400a8f', 'f': '0x400abe'}, '0x400abe': {}}, 'sub_400b11': {'0x400b6d': {'t': '0x400b35', 'f': '0x400b79'}, '0x400b7e': {}, '0x400b3a': {'t': '0x400b6d', 'f': '0x400b66'}, '0x400b11': {'t': '0x400b29', 'f': '0x400b29'}, '0x400b29': {'t': '0x400b71', 'f': '0x400b71'}, '0x400b66': {'t': '0x400b7e', 'f': '0x400b7e'}, '0x400b79': {}, '0x400b71': {'t': '0x400b35', 'f': '0x400b79'}, '0x400b35': {}}, 'sub_400bff': {'0x400c32': {'t': '0x400c3e', 'f': '0x400c3e'}, '0x400c24': {'t': '0x400c2e', 'f': '0x400c2e'}, '0x400bff': {'t': '0x400c24', 'f': '0x400c24'}, '0x400c48': {}, '0x400c2e': {'t': '0x400c48', 'f': '0x400c32'}, '0x400c3e': {}}, 'sub_400cad': {'0x400d09': {'t': '0x400d15', 'f': '0x400d15'}, '0x400cf3': {}, '0x400cd2': {'t': '0x400cde', 'f': '0x400cde'}, '0x400d15': {}, '0x400ce7': {'t': '0x400cf3', 'f': '0x400cf3'}, '0x400cad': {'t': '0x400cd2', 'f': '0x400cd2'}, '0x400cfd': {'t': '0x400d09', 'f': '0x400d09'}, '0x400cde': {'t': '0x400cfd', 'f': '0x400ce7'}}, 'main': {'0x400ddf': {}, '0x400df9': {'t': '0x400e05', 'f': '0x400e05'}, '0x400e05': {}, '0x400d9f': {'t': '0x400de1', 'f': '0x400da7'}, '0x400e07': {'t': '0x400e08', 'f': '0x400e08'}, '0x400d7e': {'t': '0x400d96', 'f': '0x400d96'}, '0x400e08': {}, '0x400df7': {}, '0x400d6d': {'t': '0x400d79', 'f': '0x400d79'}, '0x400d58': {'t': '0x400d7e', 'f': '0x400d6d'}, '0x400dac': {'t': '0x400df9', 'f': '0x400db1'}, '0x400d79': {}, '0x400d96': {'t': '0x400e07', 'f': '0x400d9f'}, '0x400dc7': {}, '0x400dc9': {'t': '0x400ddf', 'f': '0x400ddf'}, '0x400da7': {'t': '0x400dc9', 'f': '0x400dac'}, '0x400de1': {'t': '0x400df7', 'f': '0x400df7'}, '0x400db1': {'t': '0x400dc7', 'f': '0x400dc7'}}, 'sub_400e84': {'0x400e84': {}}}



function isComment(addr) {

    return ($('span#' + addr + '.token.generic:contains("#")').length > 0)
}


function removeGraph() {
    var svg = d3.select("svg > g");
    svg.selectAll("*").remove();
    $('g')[0].remove()
}


function CFGbuilder(json_cfg, func_name) {
        Object.keys(json_cfg[func_name + "_bbs"]).forEach(function(state) {
                tmp = {}
                tmp["asm"] = json_cfg[func_name + "_bbs"][state]
                tmp["obfuscated"] = "------- ----\n"
                cfg[state] = tmp
         });
        // Create a new directed graph
        g = new dagreD3.graphlib.Graph().setGraph({});
        // Add states to the graph, set labels, and style
        Object.keys(cfg).forEach(function(state) {

        var value = cfg[state];

        value.labelType="html";
        //value.label = "<pre><code id='"+state+"' class='language-nasm' >"+value.asm+"</code></pre>";
        // onmouseenter=\"selected(this);\"
        value.label = "<pre><code id='"+state+"'  class='language-nasm' >"+value.asm+"</code></pre>";
        value.rx = value.ry = 5;
        value.id = state;
        // blurred effect is set by default
        g.setNode(state, value);
        });

        var edges = json_cfg[func_name + "_edges"]["edges"]
        cfg_edges = edges;

	if (current_chall == "first_chall")
		binary_edges = first_binary_edges
	else if (current_chall == "seventh_chall")
		binary_edges = second_binary_edges 
	else if (current_chall == "fourth_chall")
		binary_edges = fourth_binary_edges
	else
		binary_edges = {}
	
        for (var i = 0; i < edges.length; i++) {
		if (func_name in binary_edges ) {
			true_false_cfg = binary_edges[func_name]
			edge_1 = edges[i][0]
			if (edge_1 in true_false_cfg) {
				branch = true_false_cfg[edge_1]	
				if ('t' in branch && branch['t'] != branch['f']) {
					if (edges[i][1] == branch['t'])
                				g.setEdge(edges[i][0], edges[i][1], {label: "", style: "stroke: #00ff00; stroke-width: 4px; fill: none "});
					else if (edges[i][1] == branch['f'])
                				g.setEdge(edges[i][0], edges[i][1], {label: "", style: "stroke: #f66; stroke-width: 4px; fill:none"});
					else
                				g.setEdge(edges[i][0], edges[i][1], {label: ""});

				}
				else {
                			g.setEdge(edges[i][0], edges[i][1], {label: ""});
				}
			}
			else {
                		g.setEdge(edges[i][0], edges[i][1], {label: ""});
			}
		}
		else {
                	g.setEdge(edges[i][0], edges[i][1], {label: ""});
		}

        }
        render = new dagreD3.render();

        // Set up an SVG group so that we can translate the final graph.
        svg = d3.select("svg"),
            inner = svg.append("g");

        // Set up zoom support
        zoom = d3.zoom()
            .on("zoom", function() {
              inner.attr("transform", d3.event.transform);
            });
        svg.call(zoom);

        // Run the renderer. This is what draws the final graph.
        render(inner, g);

        // Center the graph
        var initialScale = 1;

        svg.attr('width', 2000);
        svg.attr('height', 1024);

        d3.select('svg').transition().duration(200).call( zoom.transform, d3.zoomIdentity.translate(-1*1+400,-1*40+200).scale(0.5) );
        d3.select('svg').transition().duration(200).call( zoom.transform, d3.zoomIdentity.translate(-1*1+400,-1*40+200).scale(0.5) );
        myPrism(-1);

        downloadData();
}


function buildCallgraph() {
        for(var i in json_callgraph['nodes']) {
            var addr = json_callgraph['nodes'][i][0]
            var lab = json_callgraph['nodes'][i][1]

            var obj = new Object()
            obj['label'] = lab
            callgraph[addr] = obj

        }
        // Create a new directed graph
        call_g = new dagreD3.graphlib.Graph().setGraph({});
        // Add states to the graph, set labels, and style
        Object.keys(callgraph).forEach(function(state) {

            var value = callgraph[state];

            value.rx = value.ry = 5;

            call_g.setNode(state, value);

        });

        for (var i = 0; i < json_callgraph['edges'].length; i++) {
                call_g.setEdge(json_callgraph['edges'][i][0], json_callgraph['edges'][i][1], {label: ""});

        }
        call_render = new dagreD3.render();

        // Set up an SVG group so that we can translate the final graph.
        call_svg = d3.select("svg"),
            inner = call_svg.append("g");

        // Set up zoom support
        call_zoom = d3.zoom()
            .on("zoom", function() {
              inner.attr("transform", d3.event.transform);
            });
        call_svg.call(call_zoom);

        // Run the renderer. This is what draws the final graph.
        call_render(inner, call_g);

        // Center the graph
        var initialScale = 1.2;

        call_svg.attr('width', 1600);
        call_svg.attr('height', 1024);
        //myPrism(-1);
}


function getBBbyAddress(addr) {

    var bb
    Object.keys(cfg).forEach(function(state) {
        var res = $("code#" + state + " span.token.address:contains(" + addr  + ")")
        if(res.length > 0) {
            bb = state;
        }
    });
    return bb;
}


function cfg_getBBbyAddress(addr) {
    var bb;
    Object.keys(cfg).forEach(function(state) {
        if(cfg[state]["asm"].indexOf(addr + ":") >= 0) {
            bb = state;
        }
    });
    return bb
}


function cfg_getBBbyString(s) {
    var bb = [];
    Object.keys(cfg).forEach(function(state) {
        if(cfg[state]["asm"].indexOf(s) >= 0)
            bb.push(state);
    });
    return bb;
}



/*
function scrollToAddress() can be invoked by:
	1)"Follow this" from right-click menu
	2)"Jump to" from right click menu
	3) single click over an available address
	4) "ESC" key press
	5) Coming from string xrefs
*/
function scrollToAddress(addr, enumType) {
    var timeStamp = new Date().getTime();
    var tmpDict = {
        'timestamp' : timeStamp,
        'event' : scrollEventsEnum.properties[enumType].name,
        'element' : addr,
    };
    send_results(tmpDict);
    var bb = getBBbyAddress(addr)
    destination = bb
    rect = g._nodes[bb].elem.firstChild;
    /*rect.style["strokeWidth"]="12.5px";
    rect.style["stroke"]="#b33";*/
    x = g._nodes[bb].x;
    y = g._nodes[bb].y;
    z = d3.zoomTransform(d3.select("svg").node()).k
    d3.select('svg').transition().duration(400).call( zoom.transform, d3.zoomIdentity.translate(-1*x+500,-1*y+200).scale(1) );

}


function selected(elem){
    console.log(elem)
    if (elem && bbCache != elem.id) {
        bbCache = elem.id;
        var timeStamp = new Date().getTime();
        var tmpDict = {
            'timestamp' : timeStamp,
            'event' : 'mouseover',
            'element' : elem.id
        };

        send_results(tmpDict);
        // OBFUSCATION
	
        obfuscate(elem.id);
    }
};


function isValidAddress(addr) {
    var r = /0x[A-Za-z0-9]+/;
    return (addr.length > 5 && addr.match(r) && addr.match(r)[0] == addr)
}


function follow(addr, ex_addr, enumType) {
    myHistory = ex_addr
    if (isValidAddress(addr))
        scrollToAddress(addr, enumType)
    else
        alert("You cannot follow it")
}


function cfg_comment(codeId, tokenAddress) {
    var r = prompt("insert comment");
    if(r == "" || r == null)	return;
    if(r.length > 38) {
        r = r.substring(0, 38)
    }
    var timeStamp = new Date().getTime();
    var tmpDict = {
        'timestamp' : timeStamp,
        'event' : 'comment',
        'element' : tokenAddress.childNodes[0].id,
        'value' : r
    };
    send_results(tmpDict);
    var addr = tokenAddress.innerText.substring(0, tokenAddress.innerText.length - 1)

    var new_asm = cfg[codeId]["asm"].substring(0, cfg[codeId]["asm"].indexOf(addr)) + "# " + r + "\n" + cfg[codeId]["asm"].substring(cfg[codeId]["asm"].indexOf(addr))
    cfg[codeId]["asm"] = new_asm

    var new_label = cfg[codeId]["label"].substring(0, cfg[codeId]["label"].indexOf(addr)) + "# " + r + "\n" + cfg[codeId]["label"].substring(cfg[codeId]["label"].indexOf(addr))
    cfg[codeId]["label"] = new_label

    removeGraph();

    graphRender(codeId);


}

function on_pause() {
    var timeStamp = new Date().getTime();
    var tmpDict = {
        'timestamp' : timeStamp,
        'event' : 'pause',
        'element' : '',
        'value' : ''
    };
    send_results(tmpDict);

}

function rename_func(addr_id) {
    var value = prompt("Insert a new function name")
    if (value == "" || value == null)
	return;
    if (all_the_functions.includes(value)) {
	    alert("This name is already in use")
	    return;
    }
    $('span#' + addr_id + '.token.generic').each(function() {
        var f = $(this)[0].innerHTML.split(" ");

        for(var i in f) {
            if(typeof(f[i]) == 'string' && isValidAddress(f[i])) {
                // THIS is for replace the name in instructions like "call sub_43243"
                var func_addr = $(this)[0].innerText;
                // $(this)[0].innerText = value;
                var timeStamp = new Date().getTime();
                var tmpDict = {
                    'timestamp' : timeStamp,
                    'event' : 'func_rename',
                    'element' : func_addr,
                    'value' : value
                };
                send_results(tmpDict);

                $('span.token.number:contains(' + func_addr + ')').each(function() {

                    $(this)[0].innerText = value;
                    var id_to_search = $(this).parent()[0].id

                    var new_asm = cfg[id_to_search]["asm"].replace(func_addr, value);
                    cfg[id_to_search]["asm"] = new_asm

                    var new_label = cfg[id_to_search]["label"].replace(func_addr, value);
                    cfg[id_to_search]["label"] = new_label
                })

                return;
            }
        }
        var codeId = cfg_getBBbyAddress(addr_id);
        for(var i in f) {
            // THIS is for replace the name in instructions like "call 0x1234" (call address, not directly a function name)
            if(all_the_functions.includes(f[i].replace("\n", ""))) {
                var func = f[i];
                var new_asm = cfg[codeId]["asm"].replace(func, value);
                cfg[codeId]["asm"] = new_asm

                var new_label = cfg[codeId]["label"].replace(func, value);
                cfg[codeId]["label"] = new_label

		old_name = all_the_functions_dict[func.replace("\n", "")]
                $('a#' + old_name)[0].innerText = value;
                var timeStamp = new Date().getTime();
                var tmpDict = {
                    'timestamp' : timeStamp,
                    'event' : 'func_rename',
                    'element' : func.replace("\n", ""),
                    'value' : value
                };
                send_results(tmpDict);

                $(this)[0].innerText = " call " + value

		all_the_functions.push(value)

            }
        }
    });
}

function rename_sidenav_func(element) {
    var value = prompt("Insert a new function name");
    if (value == "" || value == null)	return;
    if (all_the_functions.includes(value)) {
	alert("This name is already in use")
	return;
    }
    var func = $('a#' + element.id)[0].innerText;
    $('a#' + element.id)[0].innerText = value;
    var timeStamp = new Date().getTime();
    var tmpDict = {
        'timestamp' : timeStamp,
        'event' : 'func_rename',
        'element' : func.replace("\n", ""),
        'value' : value
        };
    send_results(tmpDict);
}


function comment(codeId, tokenAddress) {
    var r = prompt("insert comment");
    if(r == "" || r == null)	return;
    if(r.length > 38) {
        r = r.substring(0, 38)
    }
    var timeStamp = new Date().getTime();
    var tmpDict = {
        'timestamp' : timeStamp,
        'event' : 'comment',
        'element' : tokenAddress.childNodes[0].id,
        'value' : r
    };
    send_results(tmpDict);
    $("code#" + codeId + " > span.token.address").each(function() {
        var addr = $(this)[0].innerText
        if (addr == tokenAddress.innerText) {
            // var html = tokenAddress
            var comment = "<span class='token generic'><span class='comment'># " + r + "</span></span><br>"
            $(this).before(comment)
            // oldSize = parseFloat($("code#" + codeId).css("font-size"), 10)
            // $("code#" + codeId).css("font-size", (oldSize - 3.2) + "px")
            // var oldLineHeight = parseFloat($("pre#" + codeId).css("line-height"), 10)
            // $("pre#" + codeId).css("line-height", (oldLineHeight - 2.34) + "px")

        }

    });
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function demo() {
    await sleep(1000);
    restore_graph_rename(myData);

}

async function restore(codeId) {
    await sleep(1000);
    restore_graph_rename_after_rendering(codeId);
}

// It restores both comments and function rename
function restore_graph_comments(data) {
    //downloadedData = downloadData();
    downloadedData = JSON.parse(data);
    for(var i in downloadedData) {
        var addr = downloadedData[i]['element'];
        var value = downloadedData[i]['value'];
        if(downloadedData[i]['event'] == 'comment') {
            var codeId = cfg_getBBbyAddress(addr);
            var new_asm = cfg[codeId]["asm"].substring(0, cfg[codeId]["asm"].indexOf(addr)) + "# " + value + "\n" + cfg[codeId]["asm"].substring(cfg[codeId]["asm"].indexOf(addr))
            cfg[codeId]["asm"] = new_asm

            var new_label = cfg[codeId]["label"].substring(0, cfg[codeId]["label"].indexOf(addr)) + "# " + value + "\n" + cfg[codeId]["label"].substring(cfg[codeId]["label"].indexOf(addr))
            cfg[codeId]["label"] = new_label

        }

        else {
            console.log("State-less event")
        }
    }
    removeGraph();
    graphRender(-1);
}

function restore_graph_rename_after_rendering(BBId){

    for(var i in renameVariablesData) {
        var addr = renameVariablesData[i]['element'];
        var value = renameVariablesData[i]['value'];
        if(renameVariablesData[i]['event'] == 'rename') {
            if(!listOfVars.includes(value)) {
                listOfVars.push(value);
            }
            renameVariablesData[count] = renameVariablesData[i];
            count += 1;
            var codeId = getBBbyAddress(addr);
            var inner;
            $('span#' + addr + '.token.generic').each(function() {
                if($(this).parent()[0].className == 'token local') {
                    inner = $(this)[0].innerHTML;
                }
            });
            var isBBchanged = false;
            Object.keys(cfg).forEach(function(state) {
                $("code#" + state + " a > span.token.local").each(function() {
                    if($(this)[0].textContent == inner && state != BBId) {
                        isBBchanged = true;
                        $(this)[0].innerHTML = "<span class='token generic' style='filter:blur(8px)'>" + value + "</span>"
                    }
                    else if($(this)[0].textContent == inner && state == BBId) {
                        $(this)[0].innerHTML = "<span class='token generic' style='filter:'>" + value + "</span>"
                    }
                });

            });

        }
        else {
            console.log("State-less event")
        }
    }
}


function restore_graph_rename(data) {
    downloadedData = JSON.parse(data);
    count = 0;
    for(var i in downloadedData) {
        var addr = downloadedData[i]['element'];
        var value = downloadedData[i]['value'];
        if(downloadedData[i]['event'] == 'rename') {
	    listOfRenamedVariables.push(value)
            if(!listOfVars.includes(value)) {
                listOfVars.push(value);
            }
            renameVariablesData[count] = downloadedData[i];
            count += 1;
            var codeId = getBBbyAddress(addr);
            var inner;
            $('span#' + addr + '.token.generic').each(function() {
                if($(this).parent()[0].className == 'token local') {
                    inner = $(this)[0].innerHTML;
                }
            });
            var isBBchanged = false;
            Object.keys(cfg).forEach(function(state) {
                $("code#" + state + " a > span.token.local").each(function() {
                    if($(this)[0].textContent == inner) {
                        isBBchanged = true;
                        $(this)[0].innerHTML = "<span id='" + addr + "' class='token generic' style='filter:blur(8px)'>" + value + "</span>"
                    }
                });
            });

        }
        else {
            console.log("State-less event")
        }
    }

    if(addr_to_zoom != 0) {
        scrollToAddress(addr_to_zoom, scrollEventsEnum.STR_XREF);
        obfuscate(cfg_getBBbyAddress(addr_to_zoom))
    }
}


function push_function_history(function_id, addr)
{
        console.log("Invoked push_function " + function_id + "at addr " + addr)
        if (function_id == null)
                function_id = func_to_download
        myHistory = 0
        try {
                list_of_functions = JSON.parse(localStorage.getItem('myFunctionHistory'))
        }
        catch(err) {
                console.log("We got an exception while parsing")
                localStorage.removeItem("myFunctionHistory")
                list_of_functions = null
        }
        if (list_of_functions == null)
                list_of_functions = []
        console.log("Pushing function " + function_id + "at addr " + addr)
        list_of_functions.push([function_id, addr])
        localStorage.setItem('myFunctionHistory', JSON.stringify(list_of_functions))
}

function pop_function_history()
{
        console.log("Invoked pop_function")
        try {
                list_of_functions = JSON.parse(localStorage.getItem('myFunctionHistory'))
        }
        catch(err) {
                console.log("We got an exception while parsing")
                localStorage.removeItem("myFunctionHistory")
                list_of_functions = null
        }

        if (list_of_functions == null || list_of_functions.length == 0)
                return null
        ret = list_of_functions.pop()
        localStorage.setItem('myFunctionHistory', JSON.stringify(list_of_functions))
        return ret                      // It returns an array of 2 elems (function & address)
}


function graphRender(codeId) {
     g = new dagreD3.graphlib.Graph().setGraph({});
     Object.keys(cfg).forEach(function(state) {

        var value = cfg[state];

        value.labelType="html";
        //value.label = "<pre><code id='"+state+"' class='language-nasm' >"+value.asm+"</code></pre>";
        // onmouseenter=\"selected(this);\"
        value.label = "<pre><code id='"+state+"' class='language-nasm' >"+value.asm+"</code></pre>";
        value.rx = value.ry = 5;
        // blurred effect is set by default
        g.setNode(state, value);
        });

	if (current_chall == "first_chall")
		binary_edges = first_binary_edges
	else if (current_chall == "seventh_chall")
		binary_edges = second_binary_edges 
	else if (current_chall == "fourth_chall")
		binary_edges = fourth_binary_edges
	else
		binary_edges = {}
	

	func_name = func_to_download
	edges = cfg_edges
        for (var i = 0; i < cfg_edges.length; i++) {

		if (func_name in binary_edges ) {
			true_false_cfg = binary_edges[func_name]
			edge_1 = edges[i][0]
			if (edge_1 in true_false_cfg) {
				branch = true_false_cfg[edge_1]	
				if ('t' in branch && branch['t'] != branch['f']) {
					if (edges[i][1] == branch['t'])
                				g.setEdge(edges[i][0], edges[i][1], {label: "", style: "stroke: #00ff00; stroke-width: 4px; fill: none;"});
					else if (edges[i][1] == branch['f'])
                				g.setEdge(edges[i][0], edges[i][1], {label: "", style: "stroke: #f66; stroke-width: 4px; fill: none;"});
					else
                				g.setEdge(edges[i][0], edges[i][1], {label: ""});

				}
				else {
                			g.setEdge(edges[i][0], edges[i][1], {label: ""});
				}
			}
			else {
                		g.setEdge(edges[i][0], edges[i][1], {label: ""});
			}
		}
		else {
                	g.setEdge(edges[i][0], edges[i][1], {label: ""});
		}




                //g.setEdge(cfg_edges[i][0], cfg_edges[i][1], {
                //                label: "",
                //                style: "fill: none; stroke-width: 4.5px;"
                //});
        }
        render = new dagreD3.render();

        // Set up an SVG group so that we can translate the final graph.
        svg = d3.select("svg"),
            inner = svg.append("g");


        // Set up zoom support
        zoom = d3.zoom()
            .on("zoom", function() {
              inner.attr("transform", d3.event.transform);
            });
        svg.call(zoom);

        // Run the renderer. This is what draws the final graph.
        render(inner, g);

        // Center the graph
        var initialScale = 1.2;

        svg.attr('width', 1600);
        svg.attr('height', 1024);
        restore(codeId);
        myPrism(codeId);
}

function rename(htmlElementToRename) {
    var inner = htmlElementToRename.innerHTML;
    var r = prompt("insert the new name (max 8 chars)");
    if(r == "" || r == null)    return;
    if(r.length > 8) {
        r = r.substring(0, 8)
    }
    
    if (listOfRenamedVariables.indexOf(r) >= 0) {
        alert('You already have a variable with this name')
        return
    }
    listOfRenamedVariables.push(r)
    

    var timeStamp = new Date().getTime();
    var tmpDict = {
        'timestamp' : timeStamp,
        'event' : 'rename',
        'element' : htmlElementToRename.id,
        'value' : r
    };
    send_results(tmpDict);
    var isBBchanged = false;

    renameCommentDict = {}
    Object.keys(cfg).forEach(function(state) {
        isBBchanged = false;
        $("code#" + state + " a > span.token.local").each(function() {

            if($(this)[0].textContent == inner) {
                if(state == bbCache)
                    $(this)[0].innerHTML = "<span id='" + htmlElementToRename.id + "' class='token generic'>" + r + "</span>";
                else
                    $(this)[0].innerHTML = "<span id='" + htmlElementToRename.id + "' class='token generic' style='filter:blur(8px)'>" + r + "</span>";
                isBBchanged = true;
                tokenAddress = $("code#" + state + " > span.token.address")[0]
                if (! (state in renameCommentDict)) {
                        renameCommentDict[state] = tokenAddress
                }
            }

        });
        if (isBBchanged) {
            new_asm = $("code#" + state + '.language-nasm')[0].textContent;
            cfg[state]["asm"] = new_asm;

            new_label = cfg[state]["label"].substring(0, cfg[state]["label"].indexOf(state)) + new_asm + "</code></pre>"
            cfg[state]["label"] = new_label;
        }
    });

	//generateComment = inner + " -> " + r
    if (inner[0] == "[") {
    	generateComment = "[ " + inner.substring(1, inner.length - 1) + " ] -> " + r
    }
    else {
	generateComment = "[ " + inner + " ] -> " + r
    }
    for (state in renameCommentDict) {
	do_comment(state, renameCommentDict[state], generateComment)
    }

    removeGraph()
    graphRender(bbCache)
}



function do_comment(codeId, tokenAddress, commentString) {
        var timeStamp = new Date().getTime();
        r = commentString
        var tmpDict = {
                'timestamp' : timeStamp,
                'event' : 'comment',
                'element' : tokenAddress.childNodes[0].id,
                'value' : r
        };
        send_results(tmpDict);
        var addr = tokenAddress.innerText.substring(0, tokenAddress.innerText.length - 1)

        var new_asm = cfg[codeId]["asm"].substring(0, cfg[codeId]["asm"].indexOf(addr)) + "# " + r + "\n" + cfg[codeId]["asm"].substring(cfg[codeId]["asm"].indexOf(addr))
        cfg[codeId]["asm"] = new_asm

        var new_label = cfg[codeId]["label"].substring(0, cfg[codeId]["label"].indexOf(addr)) + "# " + r + "\n" + cfg[codeId]["label"].substring(cfg[codeId]["label"].indexOf(addr))
        cfg[codeId]["label"] = new_label

}
